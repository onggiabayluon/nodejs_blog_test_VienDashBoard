<style>
 .pagewrapper {
    position: relative;
    /*background: url('http://localhost:8080/img/test.svg') center center no-repeat;*/
    text-align: center;
 } 
 .intrinsic-item2 {
    min-height: 35px;
    color: #fff;
    border-color: #000;
    border-image: initial;
    border-style: none;
    border-width: medium;
    height: auto;
    margin-bottom: 0;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
    width: auto;
    z-index: 999;
    position: relative;
 }


</style>

{{#each chapter}}
    {{#each image}}
    <div class="pagewrapper">
        <img class="intrinsic-item2" src="http://localhost:8080/img/test.svg" data-bg="{{this.url}}" alt="img">
    </div>
    {{/each}}
{{/each}}

<script>
   
    /*-- Lazy loader Image --*/
    const targets = document.querySelectorAll('.intrinsic-item2');
    const imgOptions = {
        threshhold: 1, // 1 laÃÄ toaÃÄn b√¥Ã£ b∆∞ÃÅc aÃÄnh
        rootMargin: "1200px",
    }
    const baseUrl = `https://d2qz00trz4l64d.cloudfront.net`
    var flag = 0;
    var finalSize = 0
    function querry(clientWidth) {
            if (flag == 0) {
                function setFlag() {
                   flag = 1
                };
                var mediaQueries = {
                    desktop: 1200,
                    tablets: 800,
                    phone: 400,
                };
                var clientWidthString = clientWidth
                if (clientWidthString >= mediaQueries.desktop) {
                    var size = mediaQueries.desktop  //  x >= 1200
                } else
                    if (clientWidthString >= mediaQueries.tablets && clientWidthString < mediaQueries.desktop) {
                        var size = mediaQueries.tablets //  x >= 800 x < 1200 
                    } else
                        if ((clientWidthString >= mediaQueries.phone && clientWidthString < mediaQueries.tablets) || clientWidthStringString < mediaQueries.phone) {
                            var size = mediaQueries.phone // ( x >= 400 x < 800 ) ||  x < 400
                        }
                        setFlag()
            }else if (flag == 1) {
                return 0
            }
            return parseInt(size) 
    
        }

    const lazyLoad = target => {
            const io = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    //console.log('üòç');
                    if (entry.isIntersecting) {
                        var img = new Image ();
                        img = entry.target; // Current Image
                        const src = img.getAttribute('data-bg');
                        
                        {
                           
                            const { clientWidth, clientHeight } = img
                        console.log(clientWidth)
                            const pixelRatio = window.devicePixelRatio || 1.0
                            function setFinalSize() {
                                finalSize = finalSize + querry(clientWidth)
                            };
                            setFinalSize();
                            console.log(pixelRatio)
                            const imageParams = `fit-in/${finalSize}x0/filters:quality(50)/filters:autojpg()`
                            //const imageParams = `w_${100 * Math.round(finalSize * pixelRatio / 100)},h_${100 * Math.round(finalSize * pixelRatio / 100)},q_auto,c_fill,f_auto`
                            //,g_auto nh√¢Ã£n di√™Ã£n ti√™u ƒëi√™Ãâm aÃânh
                            const url = `${baseUrl}/${imageParams}/${img.dataset.bg}`
                            img.src = `${url}`
                            //img.style.backgroundImage = `url('${url}')`
                        }   
                        observer.disconnect();
                    }
                });
            }, imgOptions);

            io.observe(target)
        };

        targets.forEach(lazyLoad);
    /*-- End Lazy loader Image --*/
</script>